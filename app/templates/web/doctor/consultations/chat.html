{% extends "web/doctor/_layout.html" %}
{% block title %}Chat Konsultasi{% endblock %}

{% block head_extra %}
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
    .chat-shell {
        border-radius: 16px;
        border: 1px solid var(--border);
        background: var(--surface);
        box-shadow: var(--shadow);
        overflow: hidden;
    }

    .chat-head {
        padding: 14px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        background: linear-gradient(180deg, rgba(22, 163, 74, .12), rgba(22, 163, 74, .04));
        border-bottom: 1px solid var(--border);
    }

    .chat-title {
        margin: 0;
        font-weight: 950;
        letter-spacing: -.02em;
        font-size: 1.05rem;
    }

    .chat-sub {
        margin: 2px 0 0;
        color: var(--muted);
        font-size: .9rem;
    }

    #chat-box {
        height: 68vh;
        overflow-y: auto;
        padding: 16px;
        background: #f9fafb;

        /* ✅ penting untuk alignment */
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .bubble {
        max-width: 72%;
        padding: 10px 12px;
        border-radius: 14px;
        font-size: 14.5px;
        line-height: 1.4;
        border: 1px solid var(--border);
        box-shadow: 0 6px 16px rgba(0, 0, 0, .04);

        /* ✅ biar tidak full width */
        width: fit-content;
        display: inline-block;
        white-space: pre-wrap;
    }

    .me {
        align-self: flex-end;
        /* ✅ kanan */
        background: rgba(22, 163, 74, .12);
        border-color: rgba(22, 163, 74, .22);
    }

    .other {
        align-self: flex-start;
        /* ✅ kiri */
        background: #fff;
    }

    .timestamp {
        font-size: 11px;
        color: var(--muted);
        margin-top: 6px;
        text-align: right;
    }

    .chat-input-wrap {
        padding: 12px;
        border-top: 1px solid var(--border);
        background: #fff;
        display: flex;
        gap: 10px;
        align-items: center;
        position: sticky;
        bottom: 0;
        z-index: 50;
    }

    #chat-input {
        flex: 1;
        border-radius: 999px;
        padding-left: 14px;
    }

    #send-btn {
        width: 44px;
        height: 44px;
        border-radius: 999px;
        border: none;
        background: var(--accent);
        color: #fff;
        display: grid;
        place-items: center;
        cursor: pointer;
        pointer-events: auto;
        position: relative;
        z-index: 60;
    }

    #send-btn:hover {
        background: var(--accent2);
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h2>Chat Konsultasi</h2>
        <p>Chat dengan pasien secara real-time.</p>
    </div>
    <a href="{{ url_for('doctor_consult.list_consultations') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i>Kembali
    </a>
</div>

<div class="chat-shell">
    <div class="chat-head">
        <div>
            <p class="chat-title mb-0">Chat dengan {{ consultation.patient.full_name }}</p>
            <p class="chat-sub mb-0">Consultation ID: #{{ consultation.id }}</p>
        </div>
        <span class="badge bg-success" style="border-radius:999px;">
            <i class="bi bi-circle-fill me-1" style="font-size:.6rem;"></i>Online
        </span>
    </div>

    <div id="chat-box">
        {% for m in messages %}
        {% if m.sender_id == current_user.id %}
        <div class="bubble me">
            {{ m.message }}
            <div class="timestamp">{{ m.created_at.strftime("%H:%M") if m.created_at else "" }}</div>
        </div>
        {% else %}
        <div class="bubble other">
            {{ m.message }}
            <div class="timestamp">{{ m.created_at.strftime("%H:%M") if m.created_at else "" }}</div>
        </div>
        {% endif %}
        {% endfor %}
    </div>

    <div class="chat-input-wrap">
        <input type="text" id="chat-input" class="form-control" placeholder="Ketik pesan..." required>
        <button id="send-btn" type="button" aria-label="Kirim">
            <i class="bi bi-send-fill"></i>
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  // indikator script hidup
  const tag = document.createElement("div");
  tag.textContent = "JS ACTIVE";
  tag.style.cssText = "position:fixed;top:10px;right:10px;z-index:999999;background:#111;color:#fff;padding:8px 10px;border-radius:10px;font-weight:800;font-size:12px;";
  document.addEventListener("DOMContentLoaded", () => document.body.appendChild(tag));

  const CURRENT_USER_ID = {{ current_user.id }};
  const consultationId = "{{ consultation.id }}";

  function fmtTime(iso){
    try{
      const d = iso ? new Date(iso) : new Date();
      return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    }catch(e){
      return "";
    }
  }

  function appendBubble(senderId, message, timestamp){
    const chatBox = document.getElementById("chat-box");
    if (!chatBox) return;

    const bubble = document.createElement("div");
    const isMe = String(senderId) === String(CURRENT_USER_ID);
    bubble.className = "bubble " + (isMe ? "me" : "other");
    bubble.innerHTML = `
      ${message}
      <div class="timestamp">${fmtTime(timestamp)}</div>
    `;

    chatBox.appendChild(bubble);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  // ✅ SOCKET LISTENER (buat pesan masuk realtime)
  // Pastikan socket.io script sudah ada di head
  const socket = io();
  const room = "consultation_" + consultationId;

  document.addEventListener("DOMContentLoaded", () => {
    socket.on("connect", () => {
      console.log("socket connected:", socket.id);
      socket.emit("join", { room: room });
    });

    socket.on("new_message", (msg) => {
      // msg = {sender_id, message, timestamp}
      // biar ga double untuk pesan kita (karena kita juga append sendiri), skip jika sender kita
      if (String(msg.sender_id) === String(CURRENT_USER_ID)) return;

      appendBubble(msg.sender_id, msg.message, msg.timestamp);
    });

    const chatBox = document.getElementById("chat-box");
    if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
  });

  // event delegation: tombol dirender kapan pun tetap ketangkep
  document.addEventListener("click", async function(e){
    const btn = e.target.closest("#send-btn");
    if (!btn) return;

    e.preventDefault();
    e.stopPropagation();

    const input = document.getElementById("chat-input");
    const chatBox = document.getElementById("chat-box");
    if (!input || !chatBox) {
      alert("DOM input/chat-box tidak ditemukan");
      return;
    }

    const message = (input.value || "").trim();
    if (!message) return;

    btn.disabled = true;

    try {
      const res = await fetch(`/doctor/consultations/${consultationId}/send`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message })
      });

      const json = await res.json().catch(()=>null);
      btn.disabled = false;

      if (!res.ok || !json || json.status !== "success") {
        alert("SEND FAILED: " + (json?.message || res.status));
        return;
      }

      // ✅ INI KUNCINYA: langsung render bubble pesan kita
      appendBubble(CURRENT_USER_ID, message, json.timestamp);

      input.value = "";
      input.focus();
    } catch(err) {
      btn.disabled = false;
      alert("FETCH ERROR: " + err);
    }
  }, true);

  // Enter untuk kirim
  document.addEventListener("keydown", function(e){
    const input = document.getElementById("chat-input");
    if (!input) return;
    if (e.target === input && e.key === "Enter") {
      e.preventDefault();
      const btn = document.getElementById("send-btn");
      if (btn) btn.click();
    }
  }, true);

})();
</script>
{% endblock %}
