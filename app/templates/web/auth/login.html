<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Login Panel | Admin & Dokter</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background: #f4f6f9;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        .login-card {
            max-width: 420px;
            width: 100%;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
            padding: 24px 26px 28px;
            background: #ffffff;
        }

        .brand-title {
            font-weight: 600;
            font-size: 1.4rem;
        }

        .form-label {
            font-weight: 500;
            font-size: 0.9rem;
        }

        .divider {
            text-align: center;
            margin: 16px 0;
            position: relative;
            font-size: 0.8rem;
            color: #6c757d;
        }

        .divider::before,
        .divider::after {
            content: "";
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: #dee2e6;
        }

        .divider::before {
            left: 0;
        }

        .divider::after {
            right: 0;
        }

        .google-icon {
            margin-right: 8px;
        }
    </style>
</head>

<body>

    <div class="login-card">
        <div class="mb-3 text-center">
            <div class="brand-title">Login Panel</div>
            <div class="text-muted" style="font-size: 0.9rem;">
                Admin & Dokter
            </div>
        </div>

        <!-- Flash messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, msg in messages %}
        <div class="alert alert-{{ category }} alert-sm py-2 px-3" role="alert">
            {{ msg }}
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <!-- Form email / password -->
        <form method="POST" class="mt-2 mb-2">
            <div class="mb-3">
                <label class="form-label">Email</label>
                <input type="email" name="email" class="form-control" placeholder="admin@contoh.com" required>
            </div>

            <div class="mb-3">
                <label class="form-label">Password</label>
                <input type="password" name="password" class="form-control" placeholder="••••••••" required>
            </div>

            <button type="submit" class="btn btn-primary w-100">
                Login
            </button>
        </form>

        <div class="divider">atau login dengan</div>

        

        <button type="button" class="btn btn-outline-success w-100 d-flex align-items-center justify-content-center"
            onclick="loginGoogle('DOKTER')">
            <img class="google-icon" src="https://developers.google.com/identity/images/g-logo.png" width="18"
                height="18" alt="G">
            <span>Login Google </span>
        </button>


        <div class="mt-3 text-center text-muted" style="font-size: 0.75rem;">
            Hanya akun dengan role <strong>ADMIN</strong> atau <strong>DOKTER</strong> yang bisa mengakses panel ini.
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
                apiKey: "AIzaSyA4UDKSvPjJRFXIa9WCAwUimF-QWrQWHbY",
                authDomain: "anemia-89bad.firebaseapp.com",
                projectId: "anemia-89bad",
                storageBucket: "anemia-89bad.firebasestorage.app",
                messagingSenderId: "30357319168",
                appId: "1:30357319168:web:0e861b4f9f240407b372e5",
                measurementId: "G-QELZL68DS1"
        };

         let auth;
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                console.log("Firebase initialized OK");
            } catch (e) {
                console.error("Firebase init failed:", e);
                alert("Firebase init gagal: " + (e?.message || e));
            }

        async function loginGoogle(role) {
    try {
      console.log("loginGoogle called, role =", role);
      const provider = new GoogleAuthProvider();
      const result = await signInWithPopup(auth, provider);
      const idToken = await result.user.getIdToken();

      const res = await fetch("/sessionLogin", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ idToken, role })
      });

      const data = await res.json().catch(() => ({}));
      console.log("sessionLogin:", res.status, data);

      if (!res.ok) {
        alert(data.error || "Login gagal (sessionLogin)");
        return;
      }

      if (data.role === "ADMIN") window.location.href = "/admin/dashboard";
      else if (data.role === "DOKTER") window.location.href = "/doctor/dashboard";
      else window.location.href = "/web/login";
    } catch (e) {
      console.error("Login error:", e);
      alert("Login error: " + (e?.message || e));
    }
  }

  window.loginGoogle = loginGoogle;
  console.log("window.loginGoogle =", typeof window.loginGoogle);
    </script>

</body>

</html>