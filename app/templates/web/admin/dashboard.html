{# templates/admin/dashboard.html #}
{% extends "web/admin/_layout.html" %}

{% block title %}Dashboard Admin{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h2>Dashboard Admin</h2>
        <p>Ringkasan statistik platform kamu.</p>
    </div>
</div>

<div class="container-fluid p-0">
    <div class="row g-3 g-lg-4">

        <div class="col-md-6 col-lg-4">
            <div class="stat-card">
                <div class="stat-top d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="stat-title mb-0">Total User</h5>
                        <div class="stat-sub">Semua akun terdaftar</div>
                    </div>
                    <div class="stat-icon"><i class="bi bi-people"></i></div>
                </div>
                <div class="stat-value">{{ total_users }}</div>
            </div>
        </div>

        <div class="col-md-6 col-lg-4">
            <div class="stat-card">
                <div class="stat-top d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="stat-title mb-0">Total Dokter</h5>
                        <div class="stat-sub">Dokter aktif</div>
                    </div>
                    <div class="stat-icon"><i class="bi bi-person-badge"></i></div>
                </div>
                <div class="stat-value">{{ total_doctors }}</div>
            </div>
        </div>

        <div class="col-md-6 col-lg-4">
            <div class="stat-card">
                <div class="stat-top d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="stat-title mb-0">Dokter Belum Diverifikasi</h5>
                        <div class="stat-sub">Butuh review admin</div>
                    </div>
                    <div class="stat-icon"><i class="bi bi-patch-exclamation"></i></div>
                </div>
                <div class="stat-value">{{ unverified_doctors }}</div>
            </div>
        </div>

        <div class="col-md-6 col-lg-4">
            <div class="stat-card">
                <div class="stat-top d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="stat-title mb-0">Total Pasien</h5>
                        <div class="stat-sub">Pasien terdaftar</div>
                    </div>
                    <div class="stat-icon"><i class="bi bi-person-heart"></i></div>
                </div>
                <div class="stat-value">{{ total_patients }}</div>
            </div>
        </div>

        <div class="col-md-6 col-lg-4">
            <div class="stat-card">
                <div class="stat-top d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="stat-title mb-0">Total Artikel</h5>
                        <div class="stat-sub">Konten terbit</div>
                    </div>
                    <div class="stat-icon"><i class="bi bi-newspaper"></i></div>
                </div>
                <div class="stat-value">{{ total_articles }}</div>
            </div>
        </div>

        <div class="col-md-6 col-lg-4">
            <div class="stat-card">
                <div class="stat-top d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="stat-title mb-0">Total Konsultasi</h5>
                        <div class="stat-sub">Semua konsultasi</div>
                    </div>
                    <div class="stat-icon"><i class="bi bi-chat-dots"></i></div>
                </div>
                <div class="stat-value">{{ total_consultations }}</div>
            </div>
        </div>
        <div class="col-md-6 col-lg-4">
            <div class="stat-card">
                <div class="stat-top">
                    <div>
                        <h5 class="stat-title">Total Konsultasi</h5>
                        <div class="stat-sub">Semua konsultasi</div>
                    </div>
                    <div class="stat-icon"><i class="bi bi-chat-dots"></i></div>
                </div>
                <div class="stat-value">{{ total_consultations }}</div>
            </div>
        </div>
        <div class="col-12">
            <div class="stat-card">
                <div class="stat-top d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="stat-title mb-0">Sentiment Feedback</h5>
                        <div class="stat-sub">Berdasarkan komentar user</div>
                    </div>
                    <div class="stat-icon"><i class="bi bi-bar-chart"></i></div>
                </div>

                <div style="height:320px;">
                    <canvas id="sentimentChart"></canvas>
                </div>
            </div>
        </div>



        {% if total_payments_success is not none %}
        <div class="col-md-6 col-lg-4">
            <div class="stat-card">
                <div class="stat-top d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="stat-title mb-0">Pembayaran Berhasil</h5>
                        <div class="stat-sub">Transaksi sukses</div>
                    </div>
                    <div class="stat-icon"><i class="bi bi-check2-circle"></i></div>
                </div>
                <div class="stat-value">{{ total_payments_success }}</div>
            </div>
        </div>
        {% endif %}

    </div>
</div>
{% endblock %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    (async function () {
        try {
            const res = await fetch("/admin/sentiment-data");
            console.log("sentiment-data status:", res.status);

            const data = await res.json();
            console.log("sentiment-data json:", data);

            const counts = data.counts || { positif: 0, netral: 0, negatif: 0 };

            const values = [counts.positif, counts.netral, counts.negatif];

            const canvas = document.getElementById("sentimentChart");
            if (!canvas) {
                console.error("Canvas #sentimentChart not found");
                return;
            }

            const allZero = values.every(v => v === 0);

            new Chart(canvas, {
                type: "doughnut",
                data: {
                    labels: allZero ? ["No Data", "No Data", "No Data"] : ["Positif", "Netral", "Negatif"],
                    datasets: [{ data: allZero ? [1, 1, 1] : values }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        } catch (e) {
            console.error("Failed load sentiment data:", e);
        }
    })();
</script>
{% endblock %}